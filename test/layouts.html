<html>
    <head>
  <script src="../lib/underscore-1.4.3-min.js"></script>
  <script src="../lib/jquery-1.8.3.js"></script>
  <script src="../lib/jquery-ui-1.9.2.custom.min.js"></script>
  <script src="../src/observable.js"></script>
  <script src="../src/content.js"></script>
  <script src="../src/mindmap.js"></script>
  <link rel="stylesheet" type="text/css" href="../lib/jquery-ui-1.9.2.custom.min.css"/>
  <link rel="stylesheet" type="text/css" href="jquery-map.css" /> 
  <style>
          #map2 {z-Index:-20;position:absolute;top:0;left:1000;background-color:gray; width:1000; height:1000}
  </style>
    </head>
    <body>
    <div tabstop="0" id="map2" class="map"> </div>
    <div tabstop="0" id="map1" class="map"> </div>
    <script src="testtree.js"></script>
    <script>
          function repaint_entire_map(active_content, jquery_map){
              jquery_map.children().detach();
              ideas_to_nodes(active_content).appendTo(jquery_map);
              paint_map_connections(jquery_map,connect_classes);
              jquery_map.find('.selected').removeClass('selected');
              jquery_map.find('.label[idea='+active_content.id+']').addClass('selected')
              var oldPos; 
              jquery_map.find('.label').draggable({
                drag: function(event,ui){
                  repaint_connection_to_parent(ui.helper, connect_classes);
                },
                start: function(event,ui){
                 oldPos=ui.helper.offset(); 
                },
                stop: function(event,ui){
                  var sibling_labels=ui.helper.parent().siblings().children('.label');
                  var groups=_.groupBy(sibling_labels,function(item){return $(item).offset().top<ui.helper.offset().top})
                  var first_below=_.min(groups[false], function(label_span) { return $(label_span).offset().top });
                  if (!active_content.positionBefore(ui.helper.attr('idea'),$(first_below).attr('idea'))){
                    ui.helper.offset(oldPos); 
                    repaint_connection_to_parent(ui.helper, connect_classes);
                  }
                }
              });
              jquery_map.find('.label').droppable({
                accept: ".label",
                activeClass: "active",
                hoverClass: "hover",
                drop: function(event,ui){
                  var newParent= $(event.target).attr('idea');
                  var ideaId= $(ui.helper).attr('idea');
                  active_content.changeParent(ideaId,newParent);
                }
              });
              jquery_map.find('.label').dblclick(function(){
                 $('.selected').removeClass('selected');
                 var originalText=$(this).text();
                 var originalLabel=$(this);
                 var dim={height: $(this).innerHeight(), width: $(this).innerWidth()};
                 var ideaId=$(this).attr('idea');
                 $(this).text("");
                 var ta=$("<textarea>"+originalText+"</textarea>").appendTo($(this));
                 ta.height(dim.height); ta.width(dim.width);
                 ta.focus();
                 ta.blur(function(){
                   active_content.updateTitle(ideaId,ta.val());
                   ta.detach();
                 });
                 ta.keyup(function(e){
                  if (e.keyCode==13){ //ENTER
                    ta.blur();
                  }
                  else if (e.keyCode==27){
                    originalLabel.text(originalText); 
                    ta.detach();
                  }
                 });
               });
               jquery_map.find('.label').click(function(event){
                  $('.selected').removeClass('selected');
                  $(event.target).addClass('selected')
               });
               
            }

          $(function(){
            var active_content=content(test_tree());
            repaint_entire_map(active_content,$('#map1'));
            active_content.addEventListener('positionBefore', function(){
              repaint_entire_map(active_content,$('#map1'));
              update_map($('#map2'),visual_to_damjan($('#map1')))
            });
            active_content.addEventListener('updateTitle', function(ideaId, newTitle){
              $('#map1').find('.label[idea='+ideaId+']').text(newTitle);
              paint_map_connections($('#map1'),connect_classes);
            });
           active_content.addEventListener('addSubIdea', function(parentIdea,title,newIdeaId){
              repaint_entire_map(active_content,$('#map1'));
              $('.selected').removeClass('selected');
              $('#map1').find('.label[idea='+newIdeaId+']').effect('bounce',{},500,function(){
                $('#map1').find('.label[idea='+newIdeaId+']').addClass('selected')
              });
            });
            active_content.addEventListener('removeSubIdea', function(ideaId){
              $('.selected').removeClass('selected');
              var node=$('#map1').find('.label[idea='+ideaId+']').parent();
              node.parent().parent().children('.label').addClass('.selected');
              node.children('.connect').detach(); 
              node.hide("fade",{},500,function(){
              node.detach();
              paint_map_connections($('#map1'),connect_classes);
              });
            });
            active_content.addEventListener('changeParent', function(ideaId,parentId){
              repaint_entire_map(active_content,$('#map1'));
              $('.selected').removeClass('selected');
              $('.label[idea='+ideaId+']').addClass('selected')
            });
            $(document).keydown(function(e) {
              var selectedId= $('.selected').attr('idea');
              if (!selectedId) return;
              if(e.which == 13) {// ENTER
                active_content.addSubIdea(selectedId,'A cunning plan');
              }
              if(e.which == 8) { // BACKSPACE
                active_content.removeSubIdea(selectedId);
                e.preventDefault();
              }
            });
            update_map($('#map2'),visual_to_damjan($('#map1')))
          }
          );
      </script>
    </body>
</html>

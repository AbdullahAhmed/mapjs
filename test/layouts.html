<html>
    <head>
  <script src="../lib/underscore-1.4.3-min.js"></script>
  <script src="../lib/jquery-1.8.3.js"></script>
  <script src="../lib/jquery-ui-1.9.2.custom.min.js"></script>
  <script src="../src/observable.js"></script>
  <script src="../src/content.js"></script>
  <script src="../src/mindmap.js"></script>
  <link rel="stylesheet" type="text/css" href="../lib/jquery-ui-1.9.2.custom.min.css">
  
      <style>
          .node{
            display:block;vertical-align:middle; margin-left:30px; margin-top:10px; margin-bottom:10px; padding:5px;
          }
          .children {
            display:inline-block;vertical-align:middle;
          }
          .label {
            display:inline-block; vertical-align:middle; border:5px solid black;padding:5px; 
            border-radius:10% ; max-width:150px; cursor:pointer;
            background-color:white;
          }
          .selected {background-color:yellow;}          
          .active {background-color:gray;}          
          .hover {background-color:red}          
          .node .node .label {
            border: 3px solid black; 
          }
          .node .node .node .label {
            border: 1px solid black; 
          }
          .map {overflow:scroll;position:absolute;top:0;left:0}
          .connect{
            position:absolute;
            z-index:-10;
          }
          .connect_down_left{
            border-top-left-radius: 50%;
            border-left: 0.3em solid #2C2C2C;
            border-top: 0.3em solid #2C2C2C;
          }
          .connect_up_left{
            border-bottom-left-radius: 50%;
            border-left: 0.3em solid #2C2C2C;
            border-bottom: 0.3em solid #2C2C2C;
          }
          .connect_down_right{
            border-top-right-radius: 50%;
            border-right: 0.3em solid #2C2C2C;
            border-top: 0.3em solid #2C2C2C;
          }
          .connect_up_right{
            border-bottom-right-radius: 50%;
            border-right: 0.3em solid #2C2C2C;
            border-bottom: 0.3em solid #2C2C2C;
          }
          .connect_horizontal{
            border-top: 0.3em solid #2C2C2C;
            padding-bottom: 0.3em;
          }
        </style>
    </head>
    <body>
    <div tabstop="0" id="map2" class="map"> </div>
    <div tabstop="0" id="map1" class="map"> </div>
      <script>
          var ideas= {
              title: 'Node 1',
              ideas: {
                1: { title: 'Node 1.1',
                     ideas: {
                       1: {title: 'Node 1.1.1'},
                       2: {title: 'Node 1.1.2'},
                       1.5: {title: 'Node 1.1.3'}
                     }
                   },
                2: { title: 'Node 1.2',
                     ideas: {
                       1: {title: 'Node 1.2.1'},
                       2: {title: 'Node 1.2.2',
                          ideas: {
                            1: {title: 'Node 1.2.2.1'},
                            2: {title: 'Node 1.2.2.2'},
                            3: {title: 'Node 1.2.2.3'}
                            }
                          },
                       3: {title: 'Node 1.2.3'}
                     }
                   },
                3: {title: 'Node 1.3'},
                '-1': { title: 'Node 1.4',
                     ideas: {
                       1: {title: 'Node 1.4.1'},
                       2: {title: 'Node 1.4.2'},
                       3: {title: 'Node 1.4.3'}
                     }
                   },
                '-2': { title: 'Node 1.5',
                     ideas: {
                       1: {title: 'Node 1.5.1'},
                       2: {title: 'Node 1.5.2',
                          ideas: {
                            1: {title: 'Node 1.5.2.1'},
                            2: {title: 'Node 1.5.2.2'},
                            3: {title: 'Node 1.5.2.3'}
                            }
                          },
                          3: {title: 'Node 1.5.3 Mozilla is a free software community best known for producing the Firefox web browser. The Mozilla community uses, develops, spreads and supports Mozilla products and works to advance the goals of the Open Web described in the Mozilla Manifesto.[1] The community is supported institutionally by the Mozilla Foundation and its tax-paying subsidiary, the Mozilla Corporation.[2] '}
                     }
                   },
                '-3': {title: 'Node 1.6'}
              }
          }
          var connect_classes={
            horizontal: "connect_horizontal",
            down_left: "connect_down_left",
            up_left: "connect_up_left",
            down_right: "connect_down_right",
            up_right: "connect_up_right"
          };
          function repaint_entire_map(active_content, jquery_map){
              jquery_map.children().detach();
              ideas_to_nodes(active_content).appendTo(jquery_map);
              paint_map_connections(jquery_map,connect_classes);
              jquery_map.find('.selected').removeClass('selected');
              jquery_map.find('.label[idea='+active_content.id+']').addClass('selected')
              var oldPos; 
              jquery_map.find('.label').draggable({
                drag: function(event,ui){
                  repaint_connection_to_parent(ui.helper, connect_classes);
                },
                start: function(event,ui){
                 oldPos=ui.helper.offset(); 
                },
                stop: function(event,ui){
                  var sibling_labels=ui.helper.parent().siblings().children('.label');
                  var groups=_.groupBy(sibling_labels,function(item){return $(item).offset().top<ui.helper.offset().top})
                  var first_below=_.min(groups[false], function(label_span) { return $(label_span).offset().top });
                  if (!active_content.positionBefore(ui.helper.attr('idea'),$(first_below).attr('idea'))){
                    ui.helper.offset(oldPos); 
                    repaint_connection_to_parent(ui.helper, connect_classes);
                  }
                }
              });
              jquery_map.find('.label').droppable({
                accept: ".label",
                activeClass: "active",
                hoverClass: "hover",
                drop: function(event,ui){
                  var newParent= $(event.target).attr('idea');
                  var ideaId= $(ui.helper).attr('idea');
                  active_content.changeParent(ideaId,newParent);
                }
              });
              jquery_map.find('.label').dblclick(function(){
                 $('.selected').removeClass('selected');
                 var originalText=$(this).text();
                 var originalLabel=$(this);
                 var dim={height: $(this).innerHeight(), width: $(this).innerWidth()};
                 var ideaId=$(this).attr('idea');
                 $(this).text("");
                 var ta=$("<textarea>"+originalText+"</textarea>").appendTo($(this));
                 ta.height(dim.height); ta.width(dim.width);
                 ta.focus();
                 ta.blur(function(){
                   active_content.updateTitle(ideaId,ta.val());
                   ta.detach();
                 });
                 ta.keyup(function(e){
                  if (e.keyCode==13){ //ENTER
                    ta.blur();
                  }
                  else if (e.keyCode==27){
                    originalLabel.text(originalText); 
                    ta.detach();
                  }
                 });
                 //var new_value=prompt('Edit idea',$(this).text());
                 //if (new_value) {
                 //  active_content.updateTitle(parseFloat($(this).attr('idea')),new_value);
                 //}
               });
               jquery_map.find('.label').click(function(event){
                  $('.selected').removeClass('selected');
                  $(event.target).addClass('selected')
               });
               
            }

          $(function(){
            var active_content=content(ideas);
            repaint_entire_map(active_content,$('#map1'));
            active_content.addEventListener('positionBefore', function(){
              repaint_entire_map(active_content,$('#map1'));
            });
            active_content.addEventListener('updateTitle', function(ideaId, newTitle){
              $('#map1').find('.label[idea='+ideaId+']').text(newTitle);
              paint_map_connections($('#map1'),connect_classes);
            });
           active_content.addEventListener('addSubIdea', function(parentIdea,title,newIdeaId){
              repaint_entire_map(active_content,$('#map1'));
              $('.selected').removeClass('selected');
              $('.label[idea='+newIdeaId+']').effect('bounce',{},500,function(){
                $('.label[idea='+newIdeaId+']').addClass('selected')
              });
            });
            active_content.addEventListener('removeSubIdea', function(ideaId){
              $('.selected').removeClass('selected');
              var node=$('.label[idea='+ideaId+']').parent();
              node.parent().parent().children('.label').addClass('.selected');
              node.children('.connect').detach(); 
              node.hide("fade",{},500,function(){
              node.detach();
              paint_map_connections($('#map1'),connect_classes);
              });
            });
            active_content.addEventListener('changeParent', function(ideaId,parentId){
              repaint_entire_map(active_content,$('#map1'));
              $('.selected').removeClass('selected');
              $('.label[idea='+ideaId+']').addClass('selected')
            });
            $(document).keydown(function(e) {
              var selectedId= $('.selected').attr('idea');
              if (!selectedId) return;
              if(e.which == 13) {// ENTER
                active_content.addSubIdea(selectedId,'A cunning plan');
              }
              if(e.which == 8) { // BACKSPACE
                active_content.removeSubIdea(selectedId);
                e.preventDefault();
              }
            });
          }
          );
      </script>
    </body>
</html>

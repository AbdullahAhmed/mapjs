<html>
    <head>
  <script src="../lib/underscore-1.4.3-min.js"></script>
  <script src="../lib/jquery-1.8.3.js"></script>
  <script src="../lib/jquery-ui-1.9.2.custom.min.js"></script>
  <script src="../src/observable.js"></script>
  <script src="../src/content.js"></script>
  <script src="../src/mindmap.js"></script>
  <link rel="stylesheet" type="text/css" href="../lib/jquery-ui-1.9.2.custom.min.css">
  
      <style>
          .node{
            display:block;vertical-align:middle; margin-left:30px; margin-top:10px; margin-bottom:10px; padding:5px;
          }
          .children {
            display:inline-block;vertical-align:middle;
          }
          .label {
            display:inline-block; vertical-align:middle; border:5px solid black;padding:5px; 
           border-radius:10% ; max-width:150px; cursor:pointer;
          }
          .selected {background-color:yellow;}          
          .active {background-color:gray;}          
          .hover {background-color:red}          
          .node .node .label {
            border: 3px solid black; 
          }
          .node .node .node .label {
            border: 1px solid black; 
          }
          .map {overflow:scroll;}
          .connect{
            position:absolute;
          }
          .connect_down_left{
            border-top-left-radius: 50%;
            border-left: 0.3em solid #2C2C2C;
            border-top: 0.3em solid #2C2C2C;
          }
          .connect_up_left{
            border-bottom-left-radius: 50%;
            border-left: 0.3em solid #2C2C2C;
            border-bottom: 0.3em solid #2C2C2C;
          }
          .connect_down_right{
            border-top-right-radius: 50%;
            border-right: 0.3em solid #2C2C2C;
            border-top: 0.3em solid #2C2C2C;
          }
          .connect_up_right{
            border-bottom-right-radius: 50%;
            border-right: 0.3em solid #2C2C2C;
            border-bottom: 0.3em solid #2C2C2C;
          }
          .connect_horizontal{
            border-bottom: 0.3em solid #2C2C2C;
          }
        </style>
    </head>
    <body>
    <div class="map"> </div>
      <script>
          var ideas= {
              title: 'Node 1',
              ideas: {
                1: { title: 'Node 1.1',
                     ideas: {
                       1: {title: 'Node 1.1.1'},
                       2: {title: 'Node 1.1.2'},
                       1.5: {title: 'Node 1.1.3'}
                     }
                   },
                2: { title: 'Node 1.2',
                     ideas: {
                       1: {title: 'Node 1.2.1'},
                       2: {title: 'Node 1.2.2',
                          ideas: {
                            1: {title: 'Node 1.2.2.1'},
                            2: {title: 'Node 1.2.2.2'},
                            3: {title: 'Node 1.2.2.3'}
                            }
                          },
                       3: {title: 'Node 1.2.3'}
                     }
                   },
                3: {title: 'Node 1.3'},
                '-1': { title: 'Node 1.4',
                     ideas: {
                       1: {title: 'Node 1.4.1'},
                       2: {title: 'Node 1.4.2'},
                       3: {title: 'Node 1.4.3'}
                     }
                   },
                '-2': { title: 'Node 1.5',
                     ideas: {
                       1: {title: 'Node 1.5.1'},
                       2: {title: 'Node 1.5.2',
                          ideas: {
                            1: {title: 'Node 1.5.2.1'},
                            2: {title: 'Node 1.5.2.2'},
                            3: {title: 'Node 1.5.2.3'}
                            }
                          },
                          3: {title: 'Node 1.5.3 Mozilla is a free software community best known for producing the Firefox web browser. The Mozilla community uses, develops, spreads and supports Mozilla products and works to advance the goals of the Open Web described in the Mozilla Manifesto.[1] The community is supported institutionally by the Mozilla Foundation and its tax-paying subsidiary, the Mozilla Corporation.[2] '}
                     }
                   },
                '-3': {title: 'Node 1.6'}
              }
          }
          function repaint_entire_map(active_content){
              $('.map').children().detach();
              ideas_to_nodes(active_content).appendTo('.map');
              paint_map_connections($('.map'));
              $('.selected').removeClass('selected');
              $('.label[idea='+active_content.id+']').addClass('selected')
              
              $('.label').draggable({
                drag: function(event,ui){
                  repaint_connection_to_parent(ui.helper.parent().find('.label'));
                },
                stop: function(event,ui){
                  var sibling_labels=ui.helper.parent().siblings().children('.label');
                  var groups=_.groupBy(sibling_labels,function(item){return $(item).offset().top<ui.helper.offset().top})
                  var first_below=_.min(groups[false], function(label_span) { return $(label_span).offset().top });
                  console.log ("positioning before id " + $(first_below).attr('idea') + "("+ $(first_below).text()+")");
                  active_content.positionBefore(ui.helper.attr('idea'),$(first_below).attr('idea'));
                  console.log("done");
                }
              });
              $('.label').droppable({
                accept: ".label",
                activeClass: "active",
                hoverClass: "hover",
                drop: function(event,ui){
                  console.log("drop");
                  var newParent= $(event.target).attr('idea');
                  var ideaId= $(ui.helper).attr('idea');
                  active_content.changeParent(ideaId,newParent);
                }
              });
              $('.label').dblclick(function(){
                 $('.selected').removeClass('selected');
                 var new_value=prompt('Edit idea',$(this).text());
                 if (new_value) {
                   active_content.updateTitle(parseFloat($(this).attr('idea')),new_value);
                 }
               });
               $('.label').click(function(event){
                  $('.selected').removeClass('selected');
                  $(event.target).addClass('selected')
               });
               
            }

          $(function(){
            var active_content=content(ideas);
            repaint_entire_map(active_content);
            active_content.addEventListener('Child_Ranks_Changed', function(){
              repaint_entire_map(active_content);
            });
            active_content.addEventListener('Title_Updated', function(idea){
              $('.map').find('.label[idea='+idea.id+']').text(idea.title);
              paint_map_connections($('.map'));
            });
            active_content.addEventListener('Idea_Added', function(idea){
              repaint_entire_map(active_content);
              $('.selected').removeClass('selected');
              $('.label[idea='+idea.id+']').addClass('selected')
            });
            active_content.addEventListener('Idea_Removed', function(ideaId){
              $('.selected').removeClass('selected');
              $('.label[idea='+ideaId+']').parent().parent().parent().children('.label').addClass('.selected');
              $('.label[idea='+ideaId+']').parent().detach();
              paint_map_connections($('.map'));
            });
            active_content.addEventListener('Parent_Changed', function(ideaId){
              repaint_entire_map(active_content);
              $('.selected').removeClass('selected');
              $('.label[idea='+ideaId+']').addClass('selected')
            });
            $(document).keyup(function(e) {
              var selectedId= $('.selected').attr('idea');
              if (!selectedId) return;
              if(e.which == 13) {// ENTER
                active_content.addSubIdea(selectedId,'A cunning plan');
              }
              if(e.which == 8) { // BACKSPACE
                active_content.removeSubIdea(selectedId);
              }
            });
          }
          );
      </script>
    </body>
</html>
